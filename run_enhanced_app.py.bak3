# run_enhanced_app.py
"""
ğŸš€ Enhanced Translation App Launcher - Phase 3B
Launcher cho á»©ng dá»¥ng dá»‹ch thuáº­t nÃ¢ng cao vá»›i Ä‘áº§y Ä‘á»§ tÃ­nh nÄƒng enterprise
"""

import streamlit as st
import sys
import os
import traceback

def setup_paths():
    """Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n Python paths"""
    current_dir = os.path.dirname(os.path.abspath(__file__))
    src_dir = os.path.join(current_dir, 'src')
    
    # ThÃªm src directory vÃ o Python path
    if src_dir not in sys.path:
        sys.path.insert(0, src_dir)
    
    print(f"âœ… ÄÃ£ thiáº¿t láº­p Python path: {src_dir}")
    return src_dir

def check_dependencies():
    """Kiá»ƒm tra dependencies cáº§n thiáº¿t"""
    required_packages = [
        'streamlit',
        'time',
        'datetime',
        'io',
        'logging'
    ]
    
    optional_packages = [
        ('PyPDF2', 'PDF processing'),
        ('pdfplumber', 'Advanced PDF extraction'),
        ('pytesseract', 'Tesseract OCR'),
        ('easyocr', 'EasyOCR engine'),
        ('PIL', 'Image processing'),
        ('reportlab', 'PDF export'),
        ('docx', 'DOCX export')
    ]
    
    print("ğŸ” Kiá»ƒm tra dependencies...")
    
    # Kiá»ƒm tra required packages
    for package in required_packages:
        try:
            __import__(package)
            print(f"âœ… {package}")
        except ImportError:
            print(f"âŒ {package} - THIáº¾U (cáº§n thiáº¿t)")
            return False
    
    # Kiá»ƒm tra optional packages
    available_features = []
    for package, feature in optional_packages:
        try:
            __import__(package)
            print(f"âœ… {package} - {feature}")
            available_features.append(feature)
        except ImportError:
            print(f"âš ï¸  {package} - {feature} (tÃ¹y chá»n)")
    
    print(f"\nğŸ¯ TÃ­nh nÄƒng kháº£ dá»¥ng: {', '.join(available_features)}")
    return True

def test_imports():
    """Test import cÃ¡c module chÃ­nh"""
    try:
        print("ğŸ“¦ Testing imports...")
        
        # Test core interfaces
        from core.interfaces.chunking import ChunkerInterface, ChunkCombinerInterface
        print("âœ… Core chunking interfaces")
        
        from core.interfaces.document_processing import DocumentProcessor, OCREngine, FormulaProcessor
        print("âœ… Document processing interfaces")
        
        # Test infrastructure
        from infrastructure.chunking.smart_chunker import SmartTextChunker
        from infrastructure.chunking.chunk_combiner import SmartChunkCombiner
        print("âœ… Chunking infrastructure")
        
        # Test services
        from application.services.enhanced_translation_service import EnhancedTranslationService
        print("âœ… Enhanced translation service")
        
        # Test app
        from app.enhanced_main import main
        print("âœ… Enhanced Streamlit app")
        
        return True
        
    except ImportError as e:
        print(f"âŒ Import error: {str(e)}")
        print("\nğŸ”§ Troubleshooting:")
        print("1. Äáº£m báº£o báº¡n Ä‘ang á»Ÿ thÆ° má»¥c gá»‘c cá»§a project")
        print("2. Kiá»ƒm tra structure thÆ° má»¥c src/")
        print("3. Táº¡o cÃ¡c file __init__.py náº¿u thiáº¿u")
        return False
    except Exception as e:
        print(f"âŒ Unexpected error: {str(e)}")
        traceback.print_exc()
        return False

def create_init_files():
    """Táº¡o cÃ¡c file __init__.py cáº§n thiáº¿t"""
    print("ğŸ“ Táº¡o __init__.py files...")
    
    init_dirs = [
        'src',
        'src/core',
        'src/core/interfaces',
        'src/infrastructure',
        'src/infrastructure/chunking',
        'src/infrastructure/processors',
        'src/infrastructure/ocr',
        'src/infrastructure/formula',
        'src/infrastructure/export',
        'src/application',
        'src/application/services',
        'src/app'
    ]
    
    for dir_path in init_dirs:
        if os.path.exists(dir_path):
            init_file = os.path.join(dir_path, '__init__.py')
            if not os.path.exists(init_file):
                with open(init_file, 'w') as f:
                    f.write('')
                print(f"âœ… Táº¡o {init_file}")
            else:
                print(f"âœ… {init_file} Ä‘Ã£ tá»“n táº¡i")
        else:
            print(f"âš ï¸  ThÆ° má»¥c {dir_path} khÃ´ng tá»“n táº¡i")

def main():
    """Main launcher function"""
    print("ğŸš€ ENHANCED TRANSLATION APP LAUNCHER")
    print("=" * 50)
    
    # BÆ°á»›c 1: Setup paths
    setup_paths()
    
    # BÆ°á»›c 2: Check dependencies
    if not check_dependencies():
        print("\nâŒ Vui lÃ²ng cÃ i Ä‘áº·t dependencies thiáº¿u vÃ  thá»­ láº¡i")
        return
    
    # BÆ°á»›c 3: Create init files
    create_init_files()
    
    # BÆ°á»›c 4: Test imports
    if not test_imports():
        print("\nâŒ Import test tháº¥t báº¡i. Kiá»ƒm tra cáº¥u trÃºc project.")
        return
    
    # BÆ°á»›c 5: Launch app
    print("\nğŸš€ Khá»Ÿi Ä‘á»™ng Enhanced Translation App...")
    print("ğŸ“Š Sáº½ má»Ÿ trÃªn: http://localhost:8511")
    print("ğŸ”„ Äang load...")
    
    try:
        from app.enhanced_main import main as app_main
        app_main()
    except Exception as e:
        print(f"âŒ Lá»—i khá»Ÿi Ä‘á»™ng app: {str(e)}")
        traceback.print_exc()
        
        print("\nğŸ”§ Fallback: Thá»­ cháº¡y Phase 3A app...")
        try:
            from app.main import main as fallback_main
            fallback_main()
        except Exception as e2:
            print(f"âŒ Fallback cÅ©ng tháº¥t báº¡i: {str(e2)}")

if __name__ == "__main__":
    main()
